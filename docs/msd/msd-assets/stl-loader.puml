@startuml
' =============================================================================
' Feature: STLLoader - STL File Importer
' Description: Loading and parsing binary/ASCII STL files
' Date: 2025-12-28
' =============================================================================

' -----------------------------------------------------------------------------
' Styling
' -----------------------------------------------------------------------------
skinparam class {
    BackgroundColor White
    BorderColor Black
}

skinparam note {
    BackgroundColor #FFFFCC
    BorderColor #999999
}

' -----------------------------------------------------------------------------
' Component Focus
' -----------------------------------------------------------------------------
package "msd_assets" {

    class STLLoader {
        ' Public interface
        {static} +loadSTL(filename: string): unique_ptr<MeshRecord>
        {static} +loadBinarySTL(filename: string): unique_ptr<MeshRecord>
        {static} +loadASCIISTL(filename: string): unique_ptr<MeshRecord>
        {static} +isBinarySTL(filename: string): bool
        {static} +trianglesToMeshRecord(triangles: vector<STLTriangle>): MeshRecord

        ' Private helpers
        {static} -readBinarySTLTriangles(filename: string): vector<STLTriangle>
        {static} -readASCIISTLTriangles(filename: string): vector<STLTriangle>
        {static} -validateBinarySTLSize(fileSize: size_t, triangleCount: uint32_t): bool
    }

    class STLTriangle {
        +normal: Vector3f
        +vertex1: Vector3f
        +vertex2: Vector3f
        +vertex3: Vector3f
    }
}

package "msd_transfer" {
    class MeshRecord {
        +vertex_data: vector<uint8_t>
        +vertex_count: uint32_t
        +triangle_count: uint32_t
        +id: int64_t
    }
}

package "Eigen" {
    class Vector3f {
        +x(), y(), z(): float
        +Vector3f(x, y, z)
    }
}

' -----------------------------------------------------------------------------
' Relationships
' -----------------------------------------------------------------------------

STLLoader ..> MeshRecord : creates
STLLoader ..> STLTriangle : parses
STLTriangle *-- Vector3f : contains

' -----------------------------------------------------------------------------
' Notes
' -----------------------------------------------------------------------------
note right of STLLoader
    **Thread Safety:** Stateless, thread-safe
    - All methods are static
    - File I/O not synchronized
    - Do not load same file concurrently

    **Pattern:** Static utility class
    - No instantiation needed
    - Format auto-detection
    - Defensive parsing

    **Error Handling:**
    - Returns nullptr on error
    - No exceptions thrown
    - Validates file format

    **Supported Formats:**
    - Binary STL (preferred)
    - ASCII STL (fallback)
end note

note as FormatDetection
    **isBinarySTL(filename):**

    Heuristic detection:

    1. Open file, read first 80 bytes
    2. Check if starts with "solid "
       → Likely ASCII (but not guaranteed!)
    3. Read triangle count (4 bytes)
    4. Calculate expected size:
       size = 80 + 4 + (count * 50)
    5. Compare with actual file size
    6. If match → Binary
    7. If mismatch → ASCII

    **Why heuristic?**
    Binary STL can have "solid " in header.
    Size validation is more reliable.
end note

note as BinaryLoading
    **loadBinarySTL(filename):**

    Binary STL format (little-endian):

    Header (80 bytes):
    - Usually "Generated by <software>"
    - Ignored during parsing

    Triangle count (4 bytes):
    - uint32_t: number of triangles

    For each triangle (50 bytes):
    - Normal: 3 floats (12 bytes)
    - Vertex 1: 3 floats (12 bytes)
    - Vertex 2: 3 floats (12 bytes)
    - Vertex 3: 3 floats (12 bytes)
    - Attribute: uint16_t (2 bytes, usually 0)

    **Process:**
    1. Validate file size
    2. Read triangle count
    3. readBinarySTLTriangles()
    4. trianglesToMeshRecord()
    5. Return unique_ptr<MeshRecord>

    **Returns nullptr if:**
    - File not found
    - Invalid size
    - Read error
end note

note as ASCIILoading
    **loadASCIISTL(filename):**

    ASCII STL format:

    solid <name>
      facet normal nx ny nz
        outer loop
          vertex x1 y1 z1
          vertex x2 y2 z2
          vertex x3 y3 z3
        endloop
      endfacet
      ...
    endsolid <name>

    **Process:**
    1. Open file as text
    2. Parse line by line:
       - "facet normal" → read normal
       - "vertex" → read vertex (3 per triangle)
    3. Build vector<STLTriangle>
    4. trianglesToMeshRecord()
    5. Return unique_ptr<MeshRecord>

    **Robustness:**
    - Handles whitespace variations
    - Skips empty lines
    - Validates keyword order

    **Returns nullptr if:**
    - File not found
    - Parse error
    - Invalid format
end note

note as TriangleConversion
    **trianglesToMeshRecord(triangles):**

    Converts STL data to MeshRecord:

    1. Allocate vertex array:
       - 3 vertices per triangle
       - Each vertex: position + color + normal
       - Total: triangles.size() * 3 vertices

    2. For each triangle:
       a. Use triangle.normal for all 3 vertices
          (STL provides per-facet normals)
       b. Set vertex positions:
          - vertex1, vertex2, vertex3
       c. Set default color (e.g., gray)

    3. Serialize to BLOB:
       - Create Vertex array
       - memcpy to vector<uint8_t>

    4. Populate MeshRecord:
       - vertex_data = BLOB
       - vertex_count = triangles.size() * 3
       - triangle_count = triangles.size()

    5. Return MeshRecord

    **Note:**
    Can be used standalone to convert
    externally-generated triangle data.
end note

note as UsagePattern
    **Typical Usage:**

    // Auto-detect and load
    auto mesh = STLLoader::loadSTL("model.stl");
    if (!mesh) {
        // Handle error
        return;
    }

    // Insert into database
    auto meshDao = db.getDAO<MeshRecord>();
    mesh->id = meshDao.insert(*mesh);

    // Later: Load as VisualGeometry
    VisualGeometry visualGeom{*mesh};

    **Explicit Format:**

    if (STLLoader::isBinarySTL("model.stl")) {
        auto mesh = STLLoader::loadBinarySTL("model.stl");
    } else {
        auto mesh = STLLoader::loadASCIISTL("model.stl");
    }

    **Integration:**
    - Used for importing external models
    - Batch conversion tools
    - Asset pipeline integration
end note

note as STLTriangleNote
    **STLTriangle:**

    Intermediate representation
    - Directly maps to STL file format
    - Uses float (matches STL spec)
    - Includes both normals and vertices

    **Why separate struct?**
    - Decouples parsing from MeshRecord
    - Allows validation/processing
    - Enables alternative conversions
end note

@enduml
