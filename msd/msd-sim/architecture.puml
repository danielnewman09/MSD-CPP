@startuml msd-sim Architecture

!theme plain
skinparam linetype ortho
skinparam groupInheritance 2

package "Engine Layer" {
  class Engine {
    - WorldModel worldModel_
    + update(simTime: chrono::milliseconds)
  }
}

package "Environment Layer" {
  class WorldModel {
    - vector<Platform> platforms_
    - chrono::milliseconds time_
    + update(simTime: chrono::milliseconds)
    + addPlatform(platform: Platform)
    + getPlatforms(): vector<Platform>&
  }

  class Platform {
    - InertialState state_
    - unique_ptr<BaseAgent> agent_
    - uint32_t id_
    + update(currTime: chrono::milliseconds)
    + getState(): InertialState
    + setState(state: InertialState)
    + setAgent(agent: unique_ptr<BaseAgent>)
  }
}

package "Mathematical Primitives" {
  class "Eigen::Vector3d" as EigenVector3d <<external>> {
    + x()
    + y()
    + z()
    + norm()
  }

  class Coordinate {
    + Coordinate(x: double, y: double, z: double)
    + operator+(other: Coordinate): Coordinate
    + operator-(other: Coordinate): Coordinate
    + operator*(scalar: double): Coordinate
    + cross(other: Coordinate): Coordinate
  }

  class Angle {
    - double value_
    + Angle(radians: double)
    + radians(): double
    + degrees(): double
    + normalize(): Angle
    + operator+(other: Angle): Angle
    + operator-(other: Angle): Angle
  }

  class EulerAngles {
    + Angle pitch
    + Angle roll
    + Angle yaw
    + EulerAngles(pitch: Angle, roll: Angle, yaw: Angle)
    + toRotationMatrix(): Eigen::Matrix3d
  }

  class InertialState {
    + Coordinate position
    + Coordinate velocity
    + Coordinate acceleration
    + EulerAngles angularPosition
    + EulerAngles angularVelocity
    + EulerAngles angularAcceleration
  }
}

package "Spatial Transformation" {
  class ReferenceFrame {
    - Coordinate origin_
    - EulerAngles euler_
    - Eigen::Matrix3d rotation_
    + globalToLocal(coord: Coordinate): Coordinate
    + localToGlobal(coord: Coordinate): Coordinate
    + globalToLocalInPlace(coord: Coordinate&)
    + localToGlobalInPlace(coord: Coordinate&)
    + globalToLocalBatch(coords: Matrix3Xd): Matrix3Xd
    + localToGlobalBatch(coords: Matrix3Xd): Matrix3Xd
    + setOrigin(origin: Coordinate)
    + setEuler(euler: EulerAngles)
  }
}

package "3D Geometry" {
  class Polyhedron {
    - Eigen::Matrix3Xd localVertices_
    - ReferenceFrame localFrame_
    - Eigen::Matrix3Xd viewerFrameVertices_
    - vector<SDL_Vertex> sdlVertices_
    - vector<SDL_FPoint> wireframeLinePoints_
    + transformToViewerFrame(viewerFrame: ReferenceFrame)
    + render(renderer: SDL_Renderer*)
    + renderWireframe(renderer: SDL_Renderer*)
    + projectTo2D(width: int, height: int, fov: double)
    + setLocalFrame(frame: ReferenceFrame)
    + getLocalFrame(): ReferenceFrame
  }

  class STLTriangle {
    + Coordinate normal
    + Coordinate vertex1
    + Coordinate vertex2
    + Coordinate vertex3
  }

  class STLLoader <<static>> {
    + {static} loadSTL(filename: string): Polyhedron
    + {static} loadBinarySTL(filename: string): vector<STLTriangle>
    + {static} loadASCIISTL(filename: string): vector<STLTriangle>
    + {static} isBinarySTL(filename: string): bool
  }
}

package "Agent System" {
  abstract class BaseAgent {
    + {abstract} updateState(currentState: InertialState): InertialState
  }

  note right of BaseAgent
    Strategy Pattern:
    User implements concrete
    agents for different control
    algorithms (autopilot, etc.)
  end note
}

package "Utilities" {
  class GeometryFactory <<static>> {
    + {static} createCube(size: double): vector<Coordinate>
    + {static} createCubeWireframe(size: double): vector<Coordinate>
  }

  class utils <<namespace>> {
    + almostEqual(a: double, b: double, epsilon: double): bool
  }
}

' Inheritance relationships
EigenVector3d <|-- Coordinate

' Composition relationships (strong ownership)
Engine *-- "1" WorldModel : contains
WorldModel *-- "*" Platform : contains
Platform *-- "1" InertialState : has state
Platform *-- "1" BaseAgent : owns (unique_ptr)

InertialState *-- "3" Coordinate : position, velocity, acceleration
InertialState *-- "1" EulerAngles : angular position
InertialState *-- "1" EulerAngles : angular velocity
InertialState *-- "1" EulerAngles : angular acceleration

EulerAngles *-- "3" Angle : pitch, roll, yaw

ReferenceFrame *-- "1" Coordinate : origin
ReferenceFrame *-- "1" EulerAngles : rotation angles

Polyhedron *-- "1" ReferenceFrame : local frame

' Association relationships (usage)
Platform ..> BaseAgent : delegates to
ReferenceFrame ..> InertialState : transforms
Polyhedron ..> ReferenceFrame : uses for viewer transform

STLLoader ..> Polyhedron : creates
STLLoader ..> STLTriangle : uses
GeometryFactory ..> Coordinate : creates vectors of

' Data flow
Engine --> WorldModel : update()
WorldModel --> Platform : update()
Platform --> BaseAgent : updateState()

legend right
  |= Symbol |= Meaning |
  | *-- | Composition (strong ownership) |
  | ..> | Dependency/Association |
  | <|-- | Inheritance |

  **Design Patterns:**
  - Strategy Pattern: BaseAgent
  - Factory Pattern: STLLoader, GeometryFactory
  - RAII: unique_ptr<BaseAgent>
  - Value Semantics: Math primitives
endlegend

@enduml
