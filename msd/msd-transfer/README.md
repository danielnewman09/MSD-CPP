# msd-transfer

Database transfer objects for the MSD asset system.

## Purpose

This library defines **lightweight, header-only structs** that represent database records for the asset management system. These structs are used by `cpp_sqlite` to automatically generate SQL schema and provide type-safe ORM functionality.

## Key Design Principles

1. **Minimal Dependencies**: Only depends on `cpp_sqlite` and `Boost.Describe`
2. **Header-Only**: No compilation required, just include headers
3. **No Domain Logic**: Pure data transfer objects (DTOs) only
4. **ORM Integration**: Uses `BOOST_DESCRIBE_STRUCT` for automatic table generation

## Structure

```
msd-transfer/
├── CMakeLists.txt
└── src/
    ├── Records.hpp                    # Convenience header (includes all)
    ├── MeshRecord.hpp                 # Visual mesh geometry
    ├── CollisionHullRecord.hpp        # Physics collision hulls
    ├── PhysicsTemplateRecord.hpp      # Complete physics templates
    └── MaterialRecord.hpp             # Rendering materials
```

## Usage

### Basic Usage

```cpp
#include <msd-transfer/src/Records.hpp>

// Create database
cpp_sqlite::Database db("assets.db", true);

// Get DAO (Data Access Object) for a record type
auto& meshDAO = db.getDAO<msd_transfer::MeshRecord>();

// Insert a mesh
msd_transfer::MeshRecord mesh;
mesh.id = meshDAO.incrementIdCounter();
mesh.name = "pyramid_visual";
mesh.vertex_count = 18;
mesh.vertex_data = serializeVertices(pyramidVertices);
meshDAO.insert(mesh);

// Query all meshes
auto allMeshes = meshDAO.selectAll();

// Query by ID
auto mesh = meshDAO.selectById(1);
if (mesh.has_value()) {
    std::cout << "Loaded mesh: " << mesh->name << "\n";
}
```

### Working with Foreign Keys

```cpp
// CollisionHullRecord references MeshRecord (optional)
msd_transfer::CollisionHullRecord hull;
hull.id = hullDAO.incrementIdCounter();
hull.name = "pyramid_collision";
hull.hull_data = serializeConvexHull(convexHull);
hull.source_mesh.id = 1;  // Reference to mesh ID 1
hullDAO.insert(hull);

// Later: resolve the foreign key
if (hull.source_mesh.isSet()) {
    auto sourceMesh = hull.source_mesh.resolve(db);
    if (sourceMesh.has_value()) {
        std::cout << "Hull generated from: " << sourceMesh->name << "\n";
    }
}
```

### Physics Templates

```cpp
msd_transfer::PhysicsTemplateRecord template;
template.id = templateDAO.incrementIdCounter();
template.name = "pyramid_standard";
template.visual_mesh.id = 1;       // Reference to MeshRecord
template.collision_hull.id = 1;    // Reference to CollisionHullRecord
template.mass = 1.0;
template.friction = 0.5;
template.restitution = 0.3;
template.inertia_tensor = serializeMatrix(inertiaTensor);
templateDAO.insert(template);
```

## Database Schema

The library defines the following tables (auto-generated by cpp_sqlite):

- **MeshRecord** → Visual mesh geometry (BLOB)
- **CollisionHullRecord** → Physics collision hulls (BLOB)
- **PhysicsTemplateRecord** → Complete object templates
- **MaterialRecord** → Rendering materials

All tables include:
- `id` (uint32_t PRIMARY KEY) - inherited from `BaseTransferObject`
- Automatic foreign key constraints
- Type-safe field access

## Integration with Other Modules

```
msd-transfer (database schema)
     ↓
msd-gui::AssetDatabase (database access)
     ↓
msd-gui::AssetRegistry (caching + domain conversion)
     ↓
msd-sim::RigidBody (domain objects)
```

**Key Point**: `msd-transfer` has NO dependencies on `msd-sim` or `msd-assets`. It only defines database structures.

## BLOB Serialization

The transfer objects store binary data as `std::vector<uint8_t>`:

- **MeshRecord::vertex_data** - Serialized `msd_assets::Vertex[]` array
- **CollisionHullRecord::hull_data** - Serialized `msd_sim::ConvexHull` vertices
- **PhysicsTemplateRecord::inertia_tensor** - Serialized 3x3 matrix (72 bytes)

Serialization/deserialization is handled by `msd-gui::AssetDatabase`, not by this library.

## Why Header-Only?

1. **Fast compilation** - No linking required
2. **Easy integration** - Just include headers
3. **ODR-safe** - All definitions are templates or inline
4. **Minimal build complexity** - No separate library artifact

## Dependencies

- **cpp_sqlite**: ORM framework
- **Boost.Describe**: Compile-time reflection
- **C++20**: For concepts and modern features

## License

Part of the MSD project.
