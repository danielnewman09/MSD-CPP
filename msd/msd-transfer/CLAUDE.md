# msd-transfer

> Database transfer objects for the MSD asset management system.

## Overview

**Location**: `msd/msd-transfer/src/`
**Type**: Header-only interface library
**Diagram**: [`../../docs/msd/msd-transfer/msd-transfer-core.puml`](../../docs/msd/msd-transfer/msd-transfer-core.puml)

## Purpose

This library defines **lightweight, header-only structs** that represent database records for the asset management system. These structs are used by `cpp_sqlite` to automatically generate SQL schema and provide type-safe ORM functionality.

### Key Design Principles

1. **Minimal Dependencies**: Only depends on `cpp_sqlite` and `Boost.Describe`
2. **Header-Only**: No compilation required, just include headers
3. **No Domain Logic**: Pure data transfer objects (DTOs) only
4. **ORM Integration**: Uses `BOOST_DESCRIBE_STRUCT` for automatic table generation
5. **Dependency Isolation**: Has NO dependencies on `msd-sim`, `msd-assets`, or `msd-gui`

## Structure

```
msd-transfer/
├── CMakeLists.txt
└── src/
    ├── Records.hpp                 # Convenience header (includes all)
    ├── MeshRecord.hpp              # Visual mesh geometry + ObjectRecord
    ├── MaterialRecord.hpp          # Rendering materials
    ├── PhysicsTemplateRecord.hpp   # Physics object templates
    ├── SimulationFrameRecord.hpp   # Frame timestamping for simulation recording
    └── InertialStateRecord.hpp     # Kinematic state with frame FK
```

## Key Classes

| Class | Header | Responsibility |
|-------|--------|----------------|
| `MeshRecord` | `MeshRecord.hpp` | Visual mesh geometry storage (vertex data as BLOB) |
| `ObjectRecord` | `MeshRecord.hpp` | Complete object definition with visual/collision mesh references |
| `MaterialRecord` | `MaterialRecord.hpp` | Rendering material properties and shader references |
| `PhysicsTemplateRecord` | `PhysicsTemplateRecord.hpp` | Rigid body template with physical properties |
| `SimulationFrameRecord` | `SimulationFrameRecord.hpp` | Frame timestamping for simulation recording |
| `InertialStateRecord` | `InertialStateRecord.hpp` | Kinematic state with frame foreign key reference |
| `Records` | `Records.hpp` | Convenience header including all record types |

## Database Schema

The library defines the following tables (auto-generated by cpp_sqlite):

| Table | Purpose | Key Fields |
|-------|---------|------------|
| **MeshRecord** | Visual mesh geometry | `vertex_data` (BLOB), `vertex_count` |
| **ObjectRecord** | Object definitions | `name`, `category`, FK to meshes |
| **MaterialRecord** | Rendering materials | `name`, shader refs, color, PBR properties |
| **PhysicsTemplateRecord** | Physics templates | `name`, FK to mesh, physical properties |
| **SimulationFrameRecord** | Frame timestamping | `simulation_time`, `wall_clock_time` |
| **InertialStateRecord** | Kinematic state | `position`, `velocity`, `orientation`, FK to frame |

All tables include:
- `id` (uint32_t PRIMARY KEY) - inherited from `BaseTransferObject`
- Automatic foreign key constraints
- Type-safe field access

## Usage

### Basic Usage

```cpp
#include <msd-transfer/src/Records.hpp>

// Create database
cpp_sqlite::Database db{"assets.db", true};

// Get DAO (Data Access Object) for a record type
auto& meshDAO = db.getDAO<msd_transfer::MeshRecord>();

// Insert a mesh
msd_transfer::MeshRecord mesh;
mesh.id = meshDAO.incrementIdCounter();
mesh.vertex_count = 18;
mesh.vertex_data = serializeVertices(pyramidVertices);
meshDAO.insert(mesh);

// Query all meshes
auto allMeshes = meshDAO.selectAll();

// Query by ID
auto mesh = meshDAO.selectById(1);
if (mesh.has_value()) {
    std::cout << "Loaded mesh with " << mesh->vertex_count << " vertices\n";
}
```

### Working with Foreign Keys

```cpp
// ObjectRecord references MeshRecord
msd_transfer::ObjectRecord obj;
obj.id = objDAO.incrementIdCounter();
obj.name = "pyramid";
obj.category = "primitives";
obj.meshRecord.id = 1;           // Reference to visual mesh ID 1
obj.collisionMeshRecord.id = 2;  // Reference to collision mesh ID 2
objDAO.insert(obj);

// Later: resolve the foreign key
if (obj.meshRecord.isSet()) {
    auto visualMesh = obj.meshRecord.resolve(db);
    if (visualMesh.has_value()) {
        std::cout << "Visual mesh: " << visualMesh->vertex_count << " vertices\n";
    }
}
```

## BLOB Serialization

The transfer objects store binary data as `std::vector<uint8_t>`:

| Field | Format | Size |
|-------|--------|------|
| `MeshRecord::vertex_data` | Serialized Vertex[] | 9 floats per vertex |
| `PhysicsTemplateRecord::inertia_tensor` | 3x3 matrix | 72 bytes (9 doubles) |

**Important**: Serialization/deserialization is handled by consuming libraries (msd-gui, msd-assets), not by this library.

## Integration with Other Modules

```
msd-transfer (database schema)
     ↓
msd-gui::AssetDatabase (database access)
     ↓
msd-assets::AssetRegistry (caching + domain conversion)
     ↓
msd-sim::RigidBody (domain objects)
```

## Thread Safety

- **Immutable after creation**: Transfer objects are pure data containers
- **No synchronization needed**: Safe to read from multiple threads
- **Database thread safety**: Depends on `cpp_sqlite::Database` implementation

## Error Handling

- No exceptions thrown by transfer objects (pure data)
- Foreign key resolution returns `std::optional<T>`
- Database errors propagate from `cpp_sqlite` layer

## Memory Management

- **Value semantics**: All records use value types (strings, vectors)
- **No ownership complexity**: Pure data containers with no pointers
- **BLOB storage**: Binary data as `std::vector<uint8_t>`
- **Foreign keys**: References by ID, resolved on demand

## Coding Standards

This library follows the project-wide coding standards defined in the [root CLAUDE.md](../../CLAUDE.md#coding-standards).

Key standards applied in this library:
- **Initialization**: Default member initializers with appropriate defaults (e.g., `mass{1.0}`)
- **Naming**: PascalCase for struct names, snake_case for member variables
- **Return Values**: Foreign key resolution returns `std::optional<T>`
- **Memory**: Value semantics throughout, no pointers in public interface

See the [root CLAUDE.md](../../CLAUDE.md#coding-standards) for complete details and examples.

## Dependencies

- **cpp_sqlite**: ORM framework for database operations
- **Boost.Describe**: Compile-time reflection for automatic schema generation
- **C++20**: For modern features

## Diagrams

| Diagram | Description |
|---------|-------------|
| [`msd-transfer-core.puml`](../../docs/msd/msd-transfer/msd-transfer-core.puml) | High-level architecture overview |
| [`records.puml`](../../docs/msd/msd-transfer/records.puml) | Detailed record structure |
