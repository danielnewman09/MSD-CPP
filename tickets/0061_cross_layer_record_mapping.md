# Ticket 0061: Cross-Layer Record Mapping Indexer

## Status
- [x] Draft
- [x] Ready for Design
- [x] Design Complete — Awaiting Review
- [x] Design Approved — Ready for Implementation
- [x] Implementation Complete — Awaiting Quality Gate
- [ ] Quality Gate Passed — Awaiting Review
- [ ] Approved — Ready for Documentation Update
- [ ] Merged / Complete

**Current Phase**: Implementation Complete — Awaiting Quality Gate
**Type**: Investigation / Tooling
**Priority**: Medium
**Assignee**: TBD
**Created**: 2026-02-13
**Generate Tutorial**: No
**Parent Ticket**: None
**Blocks**: None

---

## Overview

The MSD codebase has four representation layers for domain objects:

1. **C++ transfer records** (`msd-transfer`) — `BOOST_DESCRIBE_STRUCT` structs defining the schema
2. **SQL schema** — auto-generated by `cpp_sqlite` from the C++ records
3. **pybind11 bindings** (`msd-pybind`) — manually written Python wrappers exposing C++ records
4. **Pydantic models** (`replay/models.py`) — manually written API response schemas

The C++ → SQL link is automatic (BOOST_DESCRIBE drives cpp_sqlite). The other two links are manual and prone to drift: a new field added to a C++ record won't appear in pybind or Pydantic unless someone remembers to update them.

**Goal**: Build a traceability indexer that extracts field lists from all four layers, stores cross-layer mappings in the traceability database, and exposes them via an MCP tool. This provides visibility into what's connected and what's drifted — without changing any code generation.

### Motivation

- ~15 record types currently, growing as new recording features are added
- No automated way to detect when a C++ field exists but its pybind/Pydantic counterpart is missing
- The existing traceability database and MCP server infrastructure provide natural extension points

---

## Requirements

### R1: BOOST_DESCRIBE Field Extraction

Parse `msd-transfer/src/*.hpp` to extract `BOOST_DESCRIBE_STRUCT` field lists for each record type.

- Input: C++ header files containing `BOOST_DESCRIBE_STRUCT(RecordName, (base), (field1, field2, ...))`
- Output: Per-record list of field names, field types (primitive, nested record, ForeignKey, RepeatedField)
- Approach: Regex or tree-sitter parsing of the macro invocations
- Must handle nested sub-records (e.g., `CoordinateRecord position` inside `InertialStateRecord`)

### R2: pybind11 Binding Extraction

Parse `msd-pybind/src/record_bindings.cpp` to extract which C++ record fields are exposed to Python.

- Extract `.def_readonly("name", ...)` → direct field mapping
- Extract `.def_property_readonly("name", ...)` → computed/FK field mapping
- Associate each binding with its source C++ record type
- Track naming transformations (e.g., `ForeignKey<T> body` → pybind `body_id`)

### R3: Pydantic Model Extraction

Parse `replay/replay/models.py` to extract Pydantic model field lists.

- Extract class names and their field names + types
- Identify which C++ record each Pydantic model corresponds to (via docstring or naming convention)
- Track naming transformations (e.g., `penetrationDepth` → `penetration_depth`)

### R4: Cross-Layer Mapping Table

Store mappings in the traceability database:

```sql
CREATE TABLE record_layer_fields (
    id INTEGER PRIMARY KEY,
    record_name TEXT NOT NULL,       -- e.g., "EnergyRecord"
    layer TEXT NOT NULL,             -- "cpp", "sql", "pybind", "pydantic"
    field_name TEXT NOT NULL,        -- field name in that layer
    field_type TEXT,                 -- type info where available
    source_field TEXT,               -- corresponding C++ field name (NULL for cpp layer)
    notes TEXT                       -- e.g., "joined from SimulationFrameRecord"
);

CREATE TABLE record_layer_mapping (
    id INTEGER PRIMARY KEY,
    record_name TEXT NOT NULL,       -- C++ record name
    pydantic_model TEXT,             -- corresponding Pydantic class name (may be NULL)
    pybind_class TEXT,               -- corresponding pybind class name (may be NULL)
    sql_table TEXT                   -- corresponding SQL table name
);
```

### R5: MCP Tool Exposure

Add tool(s) to the traceability MCP server:

- `get_record_mappings(record_name)` — returns all four layers' field lists for a record, highlighting mismatches
- `check_record_drift()` — returns all records where a C++ field exists but is missing from pybind or Pydantic

### R6: Build Integration

- New CMake target: `trace-record-mappings` (follows existing `trace-git`, `trace-symbols`, `trace-decisions` pattern)
- Integrated into `debug-traceability` preset
- Indexer script: `scripts/traceability/index_record_mappings.py`

---

## Investigation Notes

### Existing Infrastructure

- Traceability database: `build/Debug/docs/traceability.db`
- Indexer pattern: `scripts/traceability/index_*.py` scripts, each populating specific tables
- MCP server: `scripts/traceability/traceability_server.py`
- Build targets: `trace-git`, `trace-symbols`, `trace-decisions` in CMake

### Field Mapping Examples

| C++ Record | C++ Field | SQL Column | pybind Attr | Pydantic Field |
|------------|-----------|------------|-------------|----------------|
| EnergyRecord | `linear_ke` | `linear_ke` | `linear_ke` | `linear_ke` |
| EnergyRecord | `body` (FK) | `body_id` | `body_id` | `body_id` |
| CollisionResultRecord | `penetrationDepth` | `penetrationDepth` | `penetrationDepth` | `penetration_depth` |
| CollisionResultRecord | `contacts` (Repeated) | junction table | `contacts` | `contacts` |
| InertialStateRecord | `acceleration` | `acceleration_id` | `acceleration` | *(not exposed)* |

### Known Naming Transformations

- `ForeignKey<T> field` → SQL: `field_id`, pybind: `field_id` (lambda), Pydantic: `field_id`
- C++ `camelCase` → Pydantic `snake_case` (e.g., `penetrationDepth` → `penetration_depth`)
- C++ `pointA` → Pydantic `point_a`
- Pydantic models intentionally omit internal/diagnostic fields (e.g., `acceleration`, `quaternionRate`)

---

## Test Plan

### Unit Tests
1. Indexer correctly parses all `BOOST_DESCRIBE_STRUCT` macros in msd-transfer
2. Indexer correctly parses all `.def_readonly` / `.def_property_readonly` in record_bindings.cpp
3. Indexer correctly parses all Pydantic model classes in models.py
4. Cross-layer mapping table populated with correct associations

### Integration Tests
1. MCP tool `get_record_mappings("EnergyRecord")` returns all four layers
2. MCP tool `check_record_drift()` correctly identifies intentionally omitted fields vs actual drift
3. `cmake --build --preset debug-traceability` runs the new indexer without errors

---

## Acceptance Criteria

1. [x] **AC1**: Indexer extracts field lists from all BOOST_DESCRIBE_STRUCT macros in msd-transfer — 28 records indexed
2. [x] **AC2**: Indexer extracts field lists from pybind11 record_bindings.cpp — 26 classes parsed
3. [x] **AC3**: Indexer extracts field lists from Pydantic models.py — 14 models parsed
4. [x] **AC4**: Cross-layer mapping stored in traceability.db with correct associations — tables populated, schema v2
5. [x] **AC5**: MCP tool `get_record_mappings()` returns per-record cross-layer field comparison — implemented and registered
6. [x] **AC6**: MCP tool `check_record_drift()` identifies fields missing from downstream layers — implemented and registered
7. [x] **AC7**: Build target `trace-record-mappings` integrated into traceability preset — CMake target builds successfully

---

## Workflow Log

### Design Phase
- **Started**: 2026-02-13 (automated via workflow-orchestrator)
- **Completed**: 2026-02-13
- **Branch**: 0061-cross-layer-record-mapping
- **PR**: #55 (draft)
- **Artifacts**:
  - `docs/designs/0061_cross_layer_record_mapping/design.md`
  - `docs/designs/0061_cross_layer_record_mapping/0061_cross_layer_record_mapping.puml`
- **Notes**:
  - Design follows existing traceability indexer pattern (index_decisions.py, index_symbols.py)
  - Four open questions documented requiring human decisions:
    1. SQL schema extraction: parse from BOOST_DESCRIBE vs query .db file (recommend parse)
    2. Naming transformation: hard-code vs heuristic (recommend hard-code)
    3. Intentional omissions: config file vs report all (recommend report all)
    4. FTS index scope: field_name only vs include type (recommend include type)
  - No math design required (tooling ticket)
  - No prototype required (straightforward regex + AST parsing)

### Design Review Phase
- **Started**: 2026-02-13 (automated via workflow-orchestrator)
- **Completed**: 2026-02-13
- **Branch**: 0061-cross-layer-record-mapping
- **PR**: #55 (draft)
- **Artifacts**:
  - Design review appended to `docs/designs/0061_cross_layer_record_mapping/design.md`
  - PR comment: https://github.com/danielnewman09/MSD-CPP/pull/55#issuecomment-3898857321
- **Notes**:
  - Status: APPROVED WITH NOTES (iteration 0, no revision needed)
  - All 4 open questions' recommendations approved
  - No prototypes required (all approaches use proven technologies)
  - 5 risks identified, all low-to-medium likelihood/impact with clear mitigations
  - Minor implementation notes: validate BOOST_DESCRIBE regex, test edge cases in camelCase conversion, accept incomplete Pydantic linkage
  - Estimated effort: 4-6 hours
  - Ready for implementation

### Implementation Phase
- **Started**: 2026-02-13 14:00 (automated via workflow-orchestrator)
- **Completed**: 2026-02-13 14:30
- **Branch**: 0061-cross-layer-record-mapping
- **PR**: #55 (ready for review)
- **Commits**:
  - b69f273: impl: implement cross-layer record mapping indexer
  - 90dec25: docs: add implementation notes and iteration log for 0061
- **Artifacts**:
  - `scripts/traceability/index_record_mappings.py` (378 LOC)
  - `scripts/traceability/traceability_schema.py` (modified, +40 lines)
  - `scripts/traceability/traceability_server.py` (modified, +144 lines)
  - `CMakeLists.txt` (modified, +13 lines)
  - `docs/designs/0061_cross_layer_record_mapping/implementation-notes.md`
  - `docs/designs/0061_cross_layer_record_mapping/iteration-log.md`
- **Test Results**:
  - ✓ Indexed 28 C++ records from msd-transfer
  - ✓ Parsed 26 pybind11 record classes
  - ✓ Parsed 14 Pydantic models
  - ✓ CMake integration successful (debug-traceability builds without errors)
  - ✓ Database schema upgraded to version 2
  - ✓ MCP tools registered and functional
- **Notes**:
  - Implementation complete on first iteration (no build-test cycles required)
  - All acceptance criteria met
  - No deviations from design
  - BOOST_DESCRIBE regex validated against all existing headers (28 records)
  - Pydantic linkage incomplete for some records (by design — docstring-based heuristic)
  - Ready for quality gate
